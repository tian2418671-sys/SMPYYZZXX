<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SPMæ‰©å±•æµ‹è¯•é¡µé¢</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #1a1a1a;
        color: white;
      }
      .test-container {
        max-width: 800px;
        margin: 0 auto;
      }
      .test-section {
        background: #2a2a2a;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        border-left: 4px solid #4caf50;
      }
      .error {
        border-left-color: #f44336;
      }
      .warning {
        border-left-color: #ff9800;
      }
      .btn {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      .btn:hover {
        background: #45a049;
      }
      .log {
        background: #0a0a0a;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>ğŸ”§ SPMæ‰©å±•æµ‹è¯•è¯Šæ–­å·¥å…·</h1>

      <div class="test-section">
        <h2>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h2>
        <p><strong>å½“å‰æ—¶é—´:</strong> <span id="current-time"></span></p>
        <p><strong>æµè§ˆå™¨:</strong> <span id="browser-info"></span></p>
        <p><strong>é¡µé¢URL:</strong> <span id="page-url"></span></p>
      </div>

      <div class="test-section">
        <h2>ğŸ” æ‰©å±•æ£€æµ‹</h2>
        <button class="btn" onclick="testExtensionFiles()">æ£€æµ‹æ‰©å±•æ–‡ä»¶</button>
        <button class="btn" onclick="testExtensionLoad()">æ£€æµ‹æ‰©å±•åŠ è½½</button>
        <button class="btn" onclick="simulateLoad()">æ¨¡æ‹ŸåŠ è½½æ‰©å±•</button>
        <div id="extension-status" class="log"></div>
      </div>

      <div class="test-section">
        <h2>ğŸ§ª åŠŸèƒ½æµ‹è¯•</h2>
        <button class="btn" onclick="testUI()">æµ‹è¯•UIåˆ›å»º</button>
        <button class="btn" onclick="testCommands()">æµ‹è¯•å‘½ä»¤</button>
        <button class="btn" onclick="clearTests()">æ¸…é™¤æµ‹è¯•</button>
        <div id="function-status" class="log"></div>
      </div>

      <div class="test-section">
        <h2>ğŸ“ è¯Šæ–­å»ºè®®</h2>
        <div id="diagnostic-advice"></div>
      </div>
    </div>

    <script>
      // æ›´æ–°åŸºæœ¬ä¿¡æ¯
      document.getElementById('current-time').textContent = new Date().toLocaleString();
      document.getElementById('browser-info').textContent = navigator.userAgent;
      document.getElementById('page-url').textContent = window.location.href;

      let testLog = '';

      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const icon = type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'âœ…';
        testLog += `[${timestamp}] ${icon} ${message}\n`;
        updateLogs();
      }

      function updateLogs() {
        document.getElementById('extension-status').textContent = testLog;
        document.getElementById('function-status').textContent = testLog;
      }

      function clearTests() {
        testLog = '';
        updateLogs();
        document.getElementById('diagnostic-advice').innerHTML = '';
      }

      async function testExtensionFiles() {
        log('å¼€å§‹æ£€æµ‹æ‰©å±•æ–‡ä»¶...');

        const files = [
          'extensions/spm-status-monito/manifest.json',
          'extensions/spm-status-monito/index.js',
          'extensions/spm-status-monito/style.css',
        ];

        for (const file of files) {
          try {
            const response = await fetch(file);
            if (response.ok) {
              log(`æ–‡ä»¶å­˜åœ¨: ${file}`);
            } else {
              log(`æ–‡ä»¶ç¼ºå¤±: ${file} (çŠ¶æ€: ${response.status})`, 'error');
            }
          } catch (error) {
            log(`æ–‡ä»¶æ£€æµ‹å¤±è´¥: ${file} - ${error.message}`, 'error');
          }
        }
      }

      function testExtensionLoad() {
        log('æ£€æµ‹æ‰©å±•åŠ è½½çŠ¶æ€...');

        if (typeof window.spmStatusMonitor !== 'undefined') {
          log('âœ… SPMæ‰©å±•å…¨å±€æ ‡è®°å­˜åœ¨');
        } else {
          log('âŒ SPMæ‰©å±•å…¨å±€æ ‡è®°ä¸å­˜åœ¨', 'error');
        }

        if (typeof window.spmDebug !== 'undefined') {
          log('âœ… SPMè°ƒè¯•æ¥å£å­˜åœ¨');
          log(`ç‰ˆæœ¬: ${window.spmDebug.version}`);
          log(`çŠ¶æ€: ${window.spmDebug.isActive() ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}`);
        } else {
          log('âŒ SPMè°ƒè¯•æ¥å£ä¸å­˜åœ¨', 'error');
        }

        // æ£€æŸ¥UIå…ƒç´ 
        const panel = document.getElementById('spm-status-panel');
        if (panel) {
          log('âœ… SPMé¢æ¿å…ƒç´ å­˜åœ¨');
        } else {
          log('âŒ SPMé¢æ¿å…ƒç´ ä¸å­˜åœ¨', 'error');
        }
      }

      function simulateLoad() {
        log('å°è¯•æ¨¡æ‹ŸåŠ è½½æ‰©å±•...');

        // æ¨¡æ‹Ÿåˆ›å»ºSPMæ‰©å±•ç¯å¢ƒ
        if (!window.eventSource) {
          window.eventSource = {
            on: function (event, handler) {
              log(`äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œ: ${event}`);
            },
          };
          window.event_types = {
            MESSAGE_SENT: 'message_sent',
            MESSAGE_RECEIVED: 'message_received',
          };
        }

        if (!window.getContext) {
          window.getContext = function () {
            return {
              extensionSettings: {},
              saveSettingsDebounced: function () {
                log('è®¾ç½®å·²ä¿å­˜');
              },
            };
          };
        }

        if (!window.registerSlashCommand) {
          window.registerSlashCommand = function (command, handler, args, help) {
            log(`æ–œæ å‘½ä»¤æ³¨å†Œ: /${command}`);
          };
        }

        log('æ¨¡æ‹Ÿç¯å¢ƒåˆ›å»ºå®Œæˆ');

        // åˆ›å»ºç®€åŒ–çš„SPMé¢æ¿
        createTestPanel();
      }

      function createTestPanel() {
        log('åˆ›å»ºæµ‹è¯•é¢æ¿...');

        // ç§»é™¤ç°æœ‰é¢æ¿
        const existingPanel = document.getElementById('spm-status-panel');
        if (existingPanel) {
          existingPanel.remove();
        }

        // åˆ›å»ºæ–°é¢æ¿
        const panel = document.createElement('div');
        panel.id = 'spm-status-panel';
        panel.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                width: 300px;
                background: rgba(0, 0, 0, 0.9);
                border: 1px solid #444;
                border-radius: 8px;
                color: white;
                font-family: Arial, sans-serif;
                z-index: 10000;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            `;

        panel.innerHTML = `
                <div style="background: #333; padding: 10px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 14px;">SPM Status Monitor v8.7.0</h3>
                    <button id="spm-close" style="background: #666; border: none; color: white; padding: 2px 6px; border-radius: 3px; cursor: pointer;">Ã—</button>
                </div>
                <div style="padding: 15px;">
                    <div style="margin-bottom: 8px; font-size: 12px;">çŠ¶æ€: <span style="color: #4CAF50; font-weight: bold;">æµ‹è¯•æ¨¡å¼</span></div>
                    <div style="margin-bottom: 8px; font-size: 12px;">ç‰ˆæœ¬: 8.7.0</div>
                    <div style="margin-bottom: 8px; font-size: 12px;">æ—¶é—´: ${new Date().toLocaleTimeString()}</div>
                </div>
            `;

        document.body.appendChild(panel);

        // ç»‘å®šå…³é—­äº‹ä»¶
        document.getElementById('spm-close').addEventListener('click', () => {
          panel.remove();
          log('æµ‹è¯•é¢æ¿å·²å…³é—­');
        });

        log('âœ… æµ‹è¯•é¢æ¿åˆ›å»ºæˆåŠŸ');
      }

      function testUI() {
        log('æµ‹è¯•UIåŠŸèƒ½...');
        createTestPanel();
      }

      function testCommands() {
        log('æµ‹è¯•å‘½ä»¤åŠŸèƒ½...');

        // æ¨¡æ‹Ÿæ–œæ å‘½ä»¤
        const panel = document.getElementById('spm-status-panel');
        if (panel) {
          const isVisible = panel.style.display !== 'none';
          panel.style.display = isVisible ? 'none' : 'block';
          log(`é¢æ¿æ˜¾ç¤ºçŠ¶æ€åˆ‡æ¢: ${isVisible ? 'éšè—' : 'æ˜¾ç¤º'}`);
        } else {
          log('é¢æ¿ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œå‘½ä»¤', 'error');
        }
      }

      // è‡ªåŠ¨è¯Šæ–­
      window.addEventListener('load', () => {
        setTimeout(() => {
          log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨è¯Šæ–­...');

          const advice = [];

          if (window.location.protocol === 'file:') {
            advice.push('âš ï¸ æ£€æµ‹åˆ°file://åè®®ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚å»ºè®®åœ¨HTTPæœåŠ¡å™¨ä¸Šè¿è¡Œã€‚');
          }

          if (!window.fetch) {
            advice.push('âŒ æµè§ˆå™¨ä¸æ”¯æŒfetch APIï¼Œè¯·å‡çº§æµè§ˆå™¨ã€‚');
          }

          if (testLog.includes('æ–‡ä»¶ç¼ºå¤±') || testLog.includes('æ£€æµ‹å¤±è´¥')) {
            advice.push('âŒ æ‰©å±•æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæƒé™ã€‚');
          }

          if (!advice.length) {
            advice.push('âœ… åŸºæœ¬ç¯å¢ƒæ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å°è¯•æ‰‹åŠ¨æµ‹è¯•æ‰©å±•åŠŸèƒ½ã€‚');
          }

          document.getElementById('diagnostic-advice').innerHTML = advice.map(item => `<p>${item}</p>`).join('');
        }, 1000);
      });
    </script>
  </body>
</html>
